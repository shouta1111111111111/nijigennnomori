<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>忍術性質変化バトル Ver.49</title>
<link href="https://fonts.googleapis.com/css2?family=Reggae+One&display=swap" rel="stylesheet">
<style>
    :root {
        --p1-color: #ff4500; --p2-color: #00bfff; --gold: #ffd700; --silver: #c0c0c0; --dark-bg: #050505;
    }
    body {
        font-family: 'Reggae One', serif; text-align: center;
        background-color: var(--dark-bg); color: #fff;
        margin: 0; overflow: hidden; height: 100dvh;
        display: flex; flex-direction: column; user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* --- 背景システム --- */
    #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; transition: background 0.5s; }
    .particle { position: absolute; border-radius: 50%; opacity: 0.6; animation: float-up linear infinite; pointer-events: none; }
    @keyframes float-up { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-10vh) scale(1.5); opacity: 0; } }

    /* 背景バリエーション */
    /* 1. 通常 */
    .bg-normal { background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
    /* 2. 木ノ葉 */
    .bg-leaf { background: radial-gradient(circle at center, #1e3c00 0%, #0a1400 100%); }
    .bg-leaf .particle { background: #4caf50 !important; border-radius: 0 !important; width: 8px !important; height: 8px !important; transform: rotate(45deg); }
    /* 3. 終末の谷 */
    .bg-valley { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); }
    .bg-valley .particle { background: #89f7fe !important; opacity: 0.4; animation-duration: 3s !important; }
    /* 4. 月読 */
    .bg-tsuku { background: radial-gradient(circle, #500000 0%, #000 100%); }
    .bg-tsuku::before { content: ""; position: absolute; top:0; left:0; width:100%; height:100%; background: repeating-linear-gradient(transparent, transparent 2px, rgba(0,0,0,0.5) 3px); pointer-events: none; }
    .bg-tsuku .particle { background: #ff0000 !important; box-shadow: 0 0 5px red; }
    /* 5. 大戦 */
    .bg-war { background: linear-gradient(to bottom, #3e3e3e, #5a4a3a); }
    .bg-war .particle { background: #d7c49e !important; width: 4px !important; }


    /* --- タイトル画面 (Cool Design) --- */
    #title-screen { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0, 0, 0, 0.6); z-index: 3000; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        transition: opacity 0.5s; backdrop-filter: blur(2px);
    }
    
    .main-logo {
        font-size: 3.5rem; color: var(--gold); 
        text-shadow: 0 0 10px #ff8c00, 3px 3px 0 #8b0000; 
        margin-bottom: 10px; line-height: 1.2; letter-spacing: 5px;
        transform: scale(1); animation: logo-breath 3s infinite ease-in-out;
    }
    .sub-logo { font-size: 1.2rem; color: #ccc; letter-spacing: 8px; margin-bottom: 30px; text-transform: uppercase; }

    @keyframes logo-breath { 0%,100%{transform:scale(1); text-shadow:0 0 10px #ff8c00, 3px 3px 0 #8b0000;} 50%{transform:scale(1.05); text-shadow:0 0 25px var(--gold), 3px 3px 0 #8b0000;} }

    /* ランク表示 (シンプル化) */
    #rank-badge {
        background: linear-gradient(90deg, transparent, rgba(0,0,0,0.8), transparent);
        padding: 5px 40px; border-top: 1px solid var(--gold); border-bottom: 1px solid var(--gold);
        margin-bottom: 40px; text-align: center;
    }
    #rank-val { font-size: 1.5rem; color: var(--gold); }
    #rank-rec { font-size: 0.9rem; color: #aaa; }

    /* メインボタン群 */
    .main-btn {
        width: 260px; padding: 18px; font-size: 1.4rem; color: #000; 
        background: var(--gold); border: none; border-radius: 50px; 
        cursor: pointer; font-family: 'Reggae One'; margin-bottom: 20px;
        box-shadow: 0 0 20px rgba(255,215,0,0.5); position: relative; overflow: hidden;
        transition: transform 0.1s;
    }
    .main-btn:active { transform: scale(0.95); }
    .main-btn::after {
        content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.8), transparent);
        transform: rotate(45deg) translate(-150%, 0); animation: shine-btn 3s infinite;
    }
    @keyframes shine-btn { 0%{transform:rotate(45deg) translate(-150%,0);} 20%{transform:rotate(45deg) translate(150%,0);} 100%{transform:rotate(45deg) translate(150%,0);} }

    .sub-btn {
        width: 200px; padding: 10px; font-size: 1rem; color: #ddd;
        background: rgba(255,255,255,0.1); border: 1px solid #666; border-radius: 30px;
        cursor: pointer; font-family: 'Reggae One'; margin-bottom: 10px; transition: 0.3s;
    }
    .sub-btn:hover { background: rgba(255,255,255,0.2); border-color: #fff; }

    /* --- 統合設定メニュー (Modal) --- */
    #settings-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 4000;
        display: none; flex-direction: column; align-items: center; justify-content: flex-start;
        padding-top: 40px; overflow-y: auto;
    }
    .settings-header { font-size: 2rem; color: var(--gold); margin-bottom: 30px; border-bottom: 2px solid var(--gold); padding-bottom: 10px; width: 80%; text-align: center; }
    
    .setting-group { width: 90%; max-width: 400px; margin-bottom: 30px; }
    .setting-label { font-size: 1.1rem; color: #fff; margin-bottom: 10px; border-left: 4px solid var(--p1-color); padding-left: 10px; text-align: left; }
    .setting-options { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .opt-btn {
        flex: 1; min-width: 80px; padding: 10px; font-size: 0.9rem;
        background: #222; color: #888; border: 1px solid #444; border-radius: 5px;
        cursor: pointer; font-family: 'Reggae One'; transition: 0.2s;
    }
    .opt-btn.active { background: rgba(255,215,0,0.2); color: var(--gold); border-color: var(--gold); box-shadow: 0 0 10px rgba(255,215,0,0.2); }
    
    .close-settings-btn {
        margin-top: 20px; width: 200px; padding: 12px; font-size: 1.2rem;
        background: #333; color: #fff; border: 1px solid #fff; border-radius: 30px;
        cursor: pointer; font-family: 'Reggae One'; margin-bottom: 50px;
    }

    /* --- 対戦形式選択モーダル --- */
    #mode-select-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 3500;
        display: none; flex-direction: column; align-items: center; justify-content: center;
    }
    .mode-card {
        width: 280px; padding: 20px; margin: 10px; background: rgba(0,0,0,0.8);
        border: 2px solid #555; border-radius: 10px; text-align: center; cursor: pointer;
        transition: 0.3s;
    }
    .mode-card:hover { border-color: var(--gold); transform: scale(1.05); }
    .mode-title { font-size: 1.5rem; color: #fff; margin-bottom: 5px; }
    .mode-desc { font-size: 0.9rem; color: #aaa; }


    /* --- ゲームエリア (共通) --- */
    .player-area { height: 35%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; z-index: 10; }
    #p2-area { transform: rotate(180deg); border-bottom: 1px solid rgba(255,255,255,0.1); }
    #p1-area { border-top: 1px solid rgba(255,255,255,0.1); }
    .hand { display: flex; justify-content: center; gap: 6px; min-height: 110px; width: 100%; align-items: flex-end; perspective: 1000px; }

    .card {
        width: 68px; height: 98px; border-radius: 6px; cursor: pointer;
        position: relative; overflow: hidden; background: #222; border: 2px solid #555;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d;
    }
    .card-inner { width: 100%; height: 100%; position: relative; z-index: 1; }
    .card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
    .card-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); color: #fff; font-size: 11px; padding: 2px 0; pointer-events: none; }
    .card.selected { transform: translateY(-25px) scale(1.1); border-color: var(--gold); box-shadow: 0 0 15px var(--gold); z-index: 100; }
    .card.selected img { opacity: 1; filter: brightness(1.1); }

    /* レアリティ演出 */
    .card.rank-silver { border-color: #c0c0c0; box-shadow: 0 0 10px rgba(192,192,192,0.5); }
    .card.rank-silver::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.5) 50%, transparent 55%); animation: shine 3s infinite; pointer-events: none; z-index: 2; }
    .card.rank-rainbow { border-color: #fff; animation: rainbow-border 2s linear infinite; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
    .card.rank-rainbow::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(125deg, rgba(255,0,0,0.3), rgba(255,165,0,0.3), rgba(255,255,0,0.3), rgba(0,128,0,0.3), rgba(0,0,255,0.3), rgba(75,0,130,0.3), rgba(238,130,238,0.3)); background-size: 200% 200%; animation: holo-move 3s ease infinite; mix-blend-mode: overlay; pointer-events: none; z-index: 3; }
    @keyframes shine { 0% { transform: translate(-30%, -30%); } 100% { transform: translate(30%, 30%); } }
    @keyframes holo-move { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes rainbow-border { 0%{border-color:red;} 20%{border-color:yellow;} 40%{border-color:lime;} 60%{border-color:cyan;} 80%{border-color:blue;} 100%{border-color:magenta;} }

    .decide-btn { width: 140px; height: 45px; margin-bottom: 5px; background: #a00; border: 2px solid #ffcc00; border-radius: 25px; color: #fff; font-family: 'Reggae One'; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.6); position: relative; z-index: 200; pointer-events: auto; }
    .decide-btn:active { transform: scale(0.96); }
    #battle-center { z-index: 50; height: 30%; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
    #score-display { font-size: 2rem; color: #fff; text-shadow: 0 0 10px #000; margin-bottom: 5px; }

    /* 演出レイヤー */
    #anim-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .clash-container { position: absolute; display: flex; gap: 5px; padding: 5px; border-radius: 10px; background: rgba(0,0,0,0.5); opacity: 0; will-change: transform; }
    .clash-img { width: 100px; height: 140px; object-fit: cover; border: 3px solid #fff; border-radius: 5px; box-shadow: 0 0 25px rgba(0,0,0,0.8); }

    /* アニメーション */
    .anim-p1-enter { animation: p1-enter 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .anim-p2-enter { animation: p2-enter 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    @keyframes p1-enter { 0%{transform:translateY(100vh) scale(0.5); opacity:0;} 60%{transform:translateY(50px) scale(1.2); opacity:1;} 100%{transform:translateY(65px) scale(1); opacity:1;} }
    @keyframes p2-enter { 0%{transform:translateY(-100vh) rotate(180deg) scale(0.5); opacity:0;} 60%{transform:translateY(-50px) rotate(180deg) scale(1.2); opacity:1;} 100%{transform:translateY(-65px) rotate(180deg) scale(1); opacity:1;} }

    .anim-p1-win { animation: p1-win 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .anim-p2-win { animation: p2-win 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes p1-win { from{transform:translateY(65px) scale(1);} to{transform:translateY(-30px) scale(1.4); z-index:2100;} }
    @keyframes p2-win { from{transform:translateY(-65px) rotate(180deg) scale(1);} to{transform:translateY(30px) rotate(180deg) scale(1.4); z-index:2100;} }

    .anim-lose-fire-p2 { animation: burn-p2 0.8s forwards; } .anim-lose-fire-p1 { animation: burn-p1 0.8s forwards; }
    @keyframes burn-p2 { 0%{transform:translateY(-65px) rotate(180deg); filter:sepia(1) saturate(5) hue-rotate(-50deg);} 100%{transform:translateY(-150px) rotate(180deg) scale(0.8); opacity:0; filter:brightness(0);} }
    @keyframes burn-p1 { 0%{transform:translateY(65px); filter:sepia(1) saturate(5) hue-rotate(-50deg);} 100%{transform:translateY(150px) scale(0.8); opacity:0; filter:brightness(0);} }
    .anim-lose-water-p2 { animation: drown-p2 0.8s forwards; } .anim-lose-water-p1 { animation: drown-p1 0.8s forwards; }
    @keyframes drown-p2 { 0%{transform:translateY(-65px) rotate(180deg); filter:hue-rotate(180deg);} 100%{transform:translateY(-65px) rotate(180deg) scale(1.5,0.1); opacity:0; filter:blur(10px);} }
    @keyframes drown-p1 { 0%{transform:translateY(65px); filter:hue-rotate(180deg);} 100%{transform:translateY(65px) scale(1.5,0.1); opacity:0; filter:blur(10px);} }
    .anim-lose-thunder-p2 { animation: shock-p2 0.6s forwards; } .anim-lose-thunder-p1 { animation: shock-p1 0.6s forwards; }
    @keyframes shock-p2 { 0%,40%{transform:translateY(-65px) rotate(180deg); filter:invert(1);} 100%{transform:translateY(-65px) rotate(180deg) scale(0); opacity:0;} }
    @keyframes shock-p1 { 0%,40%{transform:translateY(65px); filter:invert(1);} 100%{transform:translateY(65px) scale(0); opacity:0;} }
    .anim-lose-earth-p2 { animation: crush-p2 0.6s forwards; } .anim-lose-earth-p1 { animation: crush-p1 0.6s forwards; }
    @keyframes crush-p2 { 0%{transform:translateY(-65px) rotate(180deg); filter:grayscale(1);} 100%{transform:translateY(-300px) rotate(180deg) scaleY(0.2); opacity:0;} }
    @keyframes crush-p1 { 0%{transform:translateY(65px); filter:grayscale(1);} 100%{transform:translateY(300px) scaleY(0.2); opacity:0;} }
    .anim-lose-wind-p2 { animation: blast-p2 0.8s forwards; } .anim-lose-wind-p1 { animation: blast-p1 0.8s forwards; }
    @keyframes blast-p2 { 0%{transform:translateY(-65px) rotate(180deg);} 100%{transform:translateY(-100vh) rotate(720deg) scale(0); opacity:0;} }
    @keyframes blast-p1 { 0%{transform:translateY(65px);} 100%{transform:translateY(100vh) rotate(720deg) scale(0); opacity:0;} }
    
    .anim-repel-p1 { animation: repel-p1 0.5s ease-out forwards; } .anim-repel-p2 { animation: repel-p2 0.5s ease-out forwards; }
    @keyframes repel-p1 { from{transform:translateY(65px);} to{transform:translateY(300px) rotate(-45deg) scale(0.5); opacity:0;} }
    @keyframes repel-p2 { from{transform:translateY(-65px) rotate(180deg);} to{transform:translateY(-300px) rotate(225deg) scale(0.5); opacity:0;} }

    #result-text { position: absolute; font-size: 5rem; color: #fff; text-shadow: 0 0 20px var(--gold), 4px 4px 0 #000; opacity: 0; z-index: 2500; pointer-events: none; }
    @keyframes text-pop { 0%{transform:scale(0); opacity:0;} 50%{transform:scale(1.2); opacity:1;} 100%{transform:scale(1); opacity:1;} }

    #history-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); border: 1px solid #fff; color: #fff; padding: 5px 15px; border-radius: 20px; cursor: pointer; z-index: 1500; font-family: 'Reggae One'; font-size: 0.8rem; }
    #history-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3500; display: none; flex-direction: column; align-items: center; padding-top: 40px; }
    #history-content { width: 90%; max-width: 500px; height: 60%; overflow-y: auto; background: #222; border: 2px solid #555; border-radius: 10px; padding: 10px; }
    .history-row { display: flex; align-items: center; justify-content: space-between; background: #333; margin-bottom: 8px; padding: 5px; border-radius: 5px; font-size: 0.9rem; }
    .hist-cards { display: flex; gap: 2px; }
    .hist-img { width: 25px; height: 35px; object-fit: cover; border: 1px solid #777; }
    .close-hist-btn { margin-top: 20px; padding: 10px 30px; background: #555; color: #fff; border: none; border-radius: 5px; cursor: pointer; }

</style>
</head>
<body>

<div id="bg-container" class="bg-normal"></div>

<div id="title-screen">
    <div class="main-logo">忍術<br>性質変化</div>
    <div class="sub-logo">NINJA BATTLE</div>
    
    <div id="rank-badge">
        <div id="rank-val">アカデミー生</div>
        <div id="rank-rec">0勝 / 0戦</div>
    </div>

    <button class="main-btn" onclick="openModeSelect()">任務開始</button>
    <button class="sub-btn" onclick="openSettings()">環境設定</button>
    <button class="sub-btn" onclick="showHistory()">戦歴之書</button>
</div>

<div id="settings-modal">
    <div class="settings-header">環境設定</div>

    <div class="setting-group">
        <div class="setting-label">任務難易度 (ルール)</div>
        <div class="setting-options">
            <button class="opt-btn active" id="rule-norm" onclick="setRule('N')">通常<br>(3戦)</button>
            <button class="opt-btn" id="rule-adv" onclick="setRule('A')">上級<br>(5戦/弾切)</button>
        </div>
    </div>

    <div class="setting-group">
        <div class="setting-label">カード演出 (レアリティ)</div>
        <div class="setting-options">
            <button class="opt-btn active" id="eff-none" onclick="setEffect('none')">通常</button>
            <button class="opt-btn" id="eff-silver" onclick="setEffect('silver')">銀<br>(15勝)</button>
            <button class="opt-btn" id="eff-rainbow" onclick="setEffect('rainbow')">虹<br>(50勝)</button>
        </div>
    </div>

    <div class="setting-group">
        <div class="setting-label">戦場 (背景)</div>
        <div class="setting-options" style="gap:10px;">
            <button class="opt-btn active" id="bg-normal" onclick="setBg('bg-normal')">闇</button>
            <button class="opt-btn" id="bg-leaf" onclick="setBg('bg-leaf')">木ノ葉</button>
            <button class="opt-btn" id="bg-valley" onclick="setBg('bg-valley')">終末</button>
            <button class="opt-btn" id="bg-tsuku" onclick="setBg('bg-tsuku')">月読</button>
            <button class="opt-btn" id="bg-war" onclick="setBg('bg-war')">大戦</button>
        </div>
    </div>

    <button class="close-settings-btn" onclick="closeSettings()">設定終了</button>
</div>

<div id="mode-select-modal">
    <div class="mode-card" onclick="selPlay('C')">
        <div class="mode-title">単独任務</div>
        <div class="mode-desc">vs 最強AI (1 Player)</div>
    </div>
    <div class="mode-card" onclick="selPlay('P')">
        <div class="mode-title">対人演習</div>
        <div class="mode-desc">vs 友人と対戦 (2 Players)</div>
    </div>
    <button class="sub-btn" onclick="closeModeSelect()" style="margin-top:20px">戻る</button>
</div>


<div id="anim-layer"></div>
<div id="result-text"></div>
<button id="history-btn" onclick="showHistory()" style="display:none;">戦歴</button>
<div id="history-modal">
    <h2 style="color:var(--gold);">対戦記録</h2>
    <div id="history-content"></div>
    <button class="close-hist-btn" onclick="closeHistory()">閉じる</button>
</div>

<div id="p2-area" class="player-area">
    <div id="p2-hand" class="hand"></div>
    <button id="p2-btn" class="decide-btn" onclick="confirmMove(2)">P2 決定</button>
</div>
<div id="battle-center">
    <div id="score-display">
        <span style="color:var(--p1-color)">壱: <span id="s1">0</span></span>
        <span style="margin:0 20px; font-size:1.2rem">vs</span>
        <span style="color:var(--p2-color)">弐: <span id="s2">0</span></span>
    </div>
    <div id="status-msg" style="color:#aaa;">修行開始</div>
</div>
<div id="p1-area" class="player-area">
    <button id="p1-btn" class="decide-btn" onclick="confirmMove(1)">P1 決定</button>
    <div id="p1-hand" class="hand"></div>
</div>

<script>
const icons = {
    '火': 'https://livedoor.blogimg.jp/pokeruto_narutostorm/imgs/9/d/9df794cc.png',
    '水': 'https://ooyake01.com/wp-content/uploads/2019/07/%E6%89%89%E9%96%93.png',
    '土': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQgUZKzoGoqlDT7mUC9X8fE76pwS8yTZOsQJWSf0JLyzQ&s',
    '風': 'https://otakotaku.com/asset/img/character/2017/10/uzumaki-naruto-59dbafb3a0d9ep.jpg',
    '雷': 'https://images-na.ssl-images-amazon.com/images/I/71rse6gO0XL._CR550,250,1420,1420_.jpg'
};
const typeOrd={'火':1,'水':2,'土':3,'風':4,'雷':5}, types=['火','水','土','風','雷'];
const rel={'火':'風','風':'雷','雷':'土','土':'水','水':'火'};
let hands, scores, selected, confirmed, turn, gMode='N', pMode='C', p1D=[], p2D=[], firstPt=null, bannedStr=null, historyLog=[];

const RANKS = [
    { name: "アカデミー生", wins: 0 }, { name: "下忍", wins: 1 }, { name: "中忍", wins: 3 },
    { name: "特別上忍", wins: 7 }, { name: "上忍", wins: 15 }, { name: "暗部", wins: 30 },
    { name: "影", wins: 50 }, { name: "伝説の忍", wins: 100 }
];
// 初期データ (リセット済み)
let playerData = { wins: 0, matches: 0, effect: 'none', bg: 'bg-normal' };

window.onload = function() {
    loadData();
    updateTitleRank();
    applySettingsToUI();
    
    // 背景初期化
    const bg = document.getElementById('bg-container');
    bg.className = playerData.bg || 'bg-normal';
    for(let i=0; i<30; i++){
        const p = document.createElement('div'); p.className = 'particle'; 
        const size = Math.random()*5+2; p.style.width=size+'px'; p.style.height=size+'px';
        p.style.background=(Math.random()>0.5)?'#ff4500':'#00bfff'; p.style.left=Math.random()*100+'%';
        p.style.animationDuration=(Math.random()*10+5)+'s'; p.style.animationDelay=Math.random()*5+'s'; bg.appendChild(p);
    }
};

function loadData() { 
    const d = localStorage.getItem('ninjaBattleData'); 
    if(d) {
        playerData = JSON.parse(d);
        if(!playerData.effect) playerData.effect = 'none';
        if(!playerData.bg) playerData.bg = 'bg-normal';
    }
}
function saveData() { localStorage.setItem('ninjaBattleData', JSON.stringify(playerData)); }

function updateTitleRank() {
    let currentRank = RANKS[0].name;
    for(let r of RANKS) { if(playerData.wins >= r.wins) currentRank = r.name; }
    document.getElementById('rank-val').innerText = currentRank;
    document.getElementById('rank-rec').innerText = `${playerData.wins}勝 / ${playerData.matches}戦`;
}

// --- 設定関連 ---
function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; applySettingsToUI(); }
function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
function openModeSelect() { document.getElementById('mode-select-modal').style.display = 'flex'; }
function closeModeSelect() { document.getElementById('mode-select-modal').style.display = 'none'; }

function applySettingsToUI() {
    // ルール
    document.getElementById('rule-norm').className = (gMode==='N' ? 'opt-btn active' : 'opt-btn');
    document.getElementById('rule-adv').className = (gMode==='A' ? 'opt-btn active' : 'opt-btn');
    // エフェクト
    ['none','silver','rainbow'].forEach(e => {
        document.getElementById(`eff-${e}`).className = (playerData.effect===e ? 'opt-btn active' : 'opt-btn');
    });
    // 背景
    ['bg-normal','bg-leaf','bg-valley','bg-tsuku','bg-war'].forEach(b => {
        document.getElementById(b).className = (playerData.bg===b ? 'opt-btn active' : 'opt-btn');
    });
}

function setRule(m) {
    gMode = m;
    applySettingsToUI();
}
function setEffect(e) {
    // ロック機能は解除して選択可能に
    if(e === 'silver' && playerData.wins < 15) { alert("15勝するまでロックされています"); return; }
    if(e === 'rainbow' && playerData.wins < 50) { alert("50勝するまでロックされています"); return; }
    playerData.effect = e;
    saveData();
    applySettingsToUI();
}
function setBg(bgClass) {
    playerData.bg = bgClass;
    document.getElementById('bg-container').className = bgClass;
    saveData();
    applySettingsToUI();
}

// --- ゲーム開始 ---
function selPlay(p){
    pMode = p;
    closeModeSelect();
    document.getElementById('title-screen').style.opacity = '0';
    setTimeout(()=>{ document.getElementById('title-screen').style.display='none'; }, 500);
    resetGameData();
}

function resetGameData(){ hands={1:[...types],2:[...types]}; scores={1:0,2:0}; selected={1:[],2:[]}; confirmed={1:!1,2:!1}; turn=1; firstPt=null; bannedStr=null; p1D=[]; p2D=[]; historyLog=[]; document.getElementById('p2-btn').style.visibility=(pMode==='C')?'hidden':'visible'; document.getElementById('history-btn').style.display='block'; updateScoreUI(); unlockArea(1); unlockArea(2); renderHands(); updateHistoryModal(); }
function updateScoreUI(){ document.getElementById('s1').innerText = scores[1]; document.getElementById('s2').innerText = scores[2]; const max = (gMode==='N')?3:5; document.getElementById('status-msg').innerText = `第 ${turn} 戦目 (${max}戦勝負)`; }

function getCardRankClass() {
    if(playerData.effect === 'rainbow') return "rank-rainbow";
    if(playerData.effect === 'silver') return "rank-silver";
    return "";
}

function renderHands(){
    const rankClass = getCardRankClass();
    for(let p=1;p<=2;p++){
        const container = document.getElementById(`p${p}-hand`); container.innerHTML = "";
        hands[p].forEach(type => {
            const isSel = selected[p].includes(type); 
            const card = document.createElement("div"); 
            card.className = "card " + rankClass + (isSel ? " selected" : "");
            const colors = {'火':'#d32f2f','水':'#1976d2','土':'#f57c00','風':'#388e3c','雷':'#fbc02d'}; card.style.backgroundColor = colors[type];
            card.innerHTML = `<div class="card-inner"><img src="${icons[type]}" onerror="this.style.opacity='0'"><div class="card-label">${type}</div></div>`;
            card.onclick = () => { if(!confirmed[p]){ isSel ? selected[p]=selected[p].filter(t=>t!==type) : selected[p].push(type); renderHands(); }};
            container.appendChild(card);
        });
    }
}
function confirmMove(p){
    const s = selected[p].sort((a,b)=>typeOrd[a]-typeOrd[b]); const comboStr = s.join("+");
    if(s.length===0) return;
    if(s.length===2 && !(s.includes('水') && s.includes('風'))){ alert("氷遁(水+風)のみ！"); return; }
    if(s.length===3 && !(s.includes('火') && s.includes('風') && s.includes('土'))){ alert("塵遁(火+風+土)のみ！"); return; }
    if(s.length>3){ alert("4枚以上は不可"); return; }
    if(comboStr === bannedStr){ alert(`封印中：${bannedStr} 以外を出せ！`); return; }
    if(p===1) p1D=[...s]; else p2D=[...s]; confirmed[p]=!0; selected[p]=[]; renderHands(); lockArea(p);
    if(confirmed[1]){ if(pMode==='C') setTimeout(superAiLogic, 500); else if(confirmed[2]) startSlowBattle(); }
}

function superAiLogic(){
    const h2 = hands[2];
    let bestMove = null;
    let possibleMoves = [];
    h2.forEach(c => possibleMoves.push([c]));
    if(h2.includes('水')&&h2.includes('風')) possibleMoves.push(['水','風']);
    if(h2.includes('火')&&h2.includes('風')&&h2.includes('土')) possibleMoves.push(['火','風','土']);
    if(bannedStr) possibleMoves = possibleMoves.filter(m => m.join("+") !== bannedStr);

    for(let move of possibleMoves) { if(isWin(move, p1D)) { bestMove = move; if(move.length > 1) break; } }
    if(!bestMove){ for(let move of possibleMoves) { if(isDraw(move, p1D)) { bestMove = move; break; } } }
    if(!bestMove) bestMove = possibleMoves[0];
    p2D = bestMove; confirmed[2]=!0; startSlowBattle();
}
function isWin(myHand, oppHand) {
    if(myHand.length > oppHand.length) return true; if(myHand.length < oppHand.length) return false;
    if(myHand.length === 1) return rel[myHand[0]] === oppHand[0]; return false;
}
function isDraw(myHand, oppHand) { return myHand.join("+") === oppHand.join("+"); }

function startSlowBattle(){
    document.getElementById('p1-hand').style.opacity='0'; document.getElementById('p2-hand').style.opacity='0'; document.getElementById('battle-center').style.opacity='0';
    const layer = document.getElementById('anim-layer'); layer.innerHTML = '';
    const c1 = createClashContainer(p1D, '#ff4500'); c1.classList.add('anim-p1-enter'); layer.appendChild(c1);
    const c2 = createClashContainer(p2D, '#00bfff'); c2.classList.add('anim-p2-enter'); layer.appendChild(c2);
    setTimeout(() => { resolveBattle(); }, 1600);
}
function createClashContainer(cards, color){
    const box = document.createElement('div'); box.className = 'clash-container'; box.style.borderColor = color;
    const rankClass = getCardRankClass(); if(rankClass) box.classList.add(rankClass);
    cards.forEach(t => { const img = document.createElement('img'); img.src = icons[t]; img.className = 'clash-img'; img.style.borderColor = color; box.appendChild(img); });
    return box;
}
function getLoseAnimClass(cards, loserP1) {
    let type = cards[0]; if(cards.includes('火')) type='火'; if(cards.includes('風') && cards.length===2) type='水';
    const suffix = loserP1 ? 'p1' : 'p2'; const map = { '火':'fire', '水':'water', '雷':'thunder', '土':'earth', '風':'wind' };
    return `anim-lose-${map[type]||'fire'}-${suffix}`;
}

function resolveBattle(){
    const m1=p1D, m2=p2D, s1=m1.join("+"), s2=m2.join("+");
    let win=0, logRes="";
    if(m1.length > m2.length) win=1; else if(m2.length > m1.length) win=2;
    else if(m1.length===1 && rel[m1[0]]===m2[0]) win=1; else if(m1.length===1 && rel[m2[0]]===m1[0]) win=2;

    const resText = document.getElementById('result-text');
    const layer = document.getElementById('anim-layer');
    const c1 = layer.children[0]; const c2 = layer.children[1];

    c1.className = 'clash-container ' + getCardRankClass(); void c1.offsetWidth;
    c2.className = 'clash-container ' + getCardRankClass(); void c2.offsetWidth;
    c1.style.transform = 'translateY(65px) scale(1)'; c2.style.transform = 'translateY(-65px) rotate(180deg) scale(1)';

    let nextAction = null;
    if(win!==0){
        scores[win]++; if(firstPt===null) firstPt=win;
        resText.innerText = (win===1)?"壱の勝!":"弐の勝!"; resText.style.color = (win===1)?"#ff4500":"#00bfff"; logRes = `P${win} 勝利`;
        if(win===1){ c1.classList.add('anim-p1-win'); c2.classList.add(getLoseAnimClass(m1, false)); } 
        else { c2.classList.add('anim-p2-win'); c1.classList.add(getLoseAnimClass(m2, true)); }
        nextAction = () => consumeCards(m1, m2);
    } else {
        c1.classList.add('anim-repel-p1'); c2.classList.add('anim-repel-p2');
        if (s1 === s2) { 
            if (gMode === 'N') {
                if (turn === 3) { resText.innerText = "相殺(終)"; logRes="引分(終)"; nextAction = () => consumeCards(m1, m2); }
                else { resText.innerText = "出し直し"; logRes="あいこ"; bannedStr = null; nextAction = () => resetTurn(); }
            } else if (gMode === 'A' && turn === 1) { 
                bannedStr = s1; resText.innerText = "封印!!"; logRes="封印"; nextAction = () => resetTurn();
            } else { resText.innerText = "相殺"; logRes="引分"; nextAction = () => consumeCards(m1, m2); }
        } else { resText.innerText = "相殺"; logRes="引分"; nextAction = () => consumeCards(m1, m2); }
    }
    
    addHistory(turn, p1D, p2D, logRes);
    resText.style.animation = 'text-pop 0.5s forwards';

    setTimeout(() => {
        layer.innerHTML = ''; resText.style.opacity = '0'; resText.style.animation = 'none';
        document.getElementById('p1-hand').style.opacity='1'; document.getElementById('p2-hand').style.opacity='1'; document.getElementById('battle-center').style.opacity='1';
        nextAction(); updateScoreUI(); renderHands(); checkGameOver();
    }, 2000);
}

function checkGameOver(){
    let isGameOver = false;
    const limit = (gMode === 'N') ? 3 : 5;
    if (scores[1] >= 2 || scores[2] >= 2) isGameOver = true;
    else if (gMode === 'N' && turn > limit) isGameOver = true;
    else if (gMode === 'A' && (turn > limit || hands[1].length === 0 || hands[2].length === 0)) isGameOver = true;
    if(isGameOver) setTimeout(judgeFinal, 800); else resetTurn();
}
function consumeCards(m1, m2) { m1.forEach(c=>hands[1].splice(hands[1].indexOf(c),1)); m2.forEach(c=>hands[2].splice(hands[2].indexOf(c),1)); turn++; bannedStr=null; }
function resetTurn(){ confirmed={1:!1,2:!1}; p1D=[]; p2D=[]; selected={1:[],2:[]}; unlockArea(1); unlockArea(2); renderHands(); }
function addHistory(t, h1, h2, res){ historyLog.push({ turn: t, h1: [...h1], h2: [...h2], res: res }); updateHistoryModal(); }
function updateHistoryModal(){
    const content = document.getElementById('history-content');
    if(historyLog.length === 0){ content.innerHTML = '<div style="color:#aaa; text-align:center;">まだ記録はありません</div>'; return; }
    let html = '';
    historyLog.forEach(log => {
        const genImgs = (arr) => arr.map(type => `<img src="${icons[type]}" class="hist-img">`).join('');
        html += `<div class="history-row"><div style="width:20px;">${log.turn}</div><div class="hist-cards">${genImgs(log.h1)}</div><div style="font-weight:bold; color:var(--gold);">${log.res}</div><div class="hist-cards">${genImgs(log.h2)}</div></div>`;
    });
    content.innerHTML = html;
}
function showHistory(){ document.getElementById('history-modal').style.display = 'flex'; }
function closeHistory(){ document.getElementById('history-modal').style.display = 'none'; }
function judgeFinal(){
    let w = 0, res = "";
    if (scores[1] > scores[2]) { w = 1; res = "勝星多数"; } else if (scores[2] > scores[1]) { w = 2; res = "勝星多数"; }
    else { if (hands[1].length > hands[2].length) { w = 1; res = "残手札数"; } else if (hands[2].length > hands[1].length) { w = 2; res = "残手札数"; }
    else { if (firstPt === 1) { w = 1; res = "先陣の功"; } else if (firstPt === 2) { w = 2; res = "先陣の功"; } else { w = 0; res = "完全引分"; } } }
    
    playerData.matches++; if(w === 1) playerData.wins++;
    saveData(); updateTitleRank();

    const menu = document.getElementById('menu-screen'); menu.style.display = 'flex'; setTimeout(()=>menu.style.opacity='1', 10);
    menu.innerHTML = `
        <h1 style="color:var(--gold)">勝負あり</h1>
        <h2 style="font-size:2rem; margin-top:-20px">${w===0 ? '引き分け' : '勝者：プレイヤー'+w}</h2>
        <p>決まり手：${res}</p>
        <button class="start-btn" onclick="location.reload()">再戦</button>
        <button class="sub-btn" onclick="showHistory()" style="margin-top:10px;">戦歴を見る</button>
    `;
}
function lockArea(p){ document.getElementById(`p${p}-area`).style.filter='grayscale(100%) brightness(0.3)'; document.getElementById(`p${p}-btn`).style.pointerEvents='none'; }
function unlockArea(p){ document.getElementById(`p${p}-area`).style.filter='none'; document.getElementById(`p${p}-btn`).style.pointerEvents='auto'; }
</script>
</body>
</html>
